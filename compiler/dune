(executable
 (libraries extracted menhirLib)
 (modules main parser generation locationInfo lexer parserMessages)
 (name main)
 (public_name compiler))

(executable
  (modules gen_tests)
  (name gen_tests)
)

(ocamllex
 (modules lexer))

(menhir
 (modules parser)
 (flags --explain --table))

(rule
  (deps parserMessages.check)
  (action (with-stdout-to parserMessages.ml
    (run menhir
      ;; Menhir flags
      %{dep:parser.mly}
      --compile-errors %{dep:parserMessages.messages}
    )
  ))
)

;; In order to perform the completeness check, we must first generate a file
;; "parserMessages.auto.messages" that contains a list of all error states.

(rule
  (with-stdout-to parserMessages.auto.messages
    (run menhir
       ;; Menhir flags
       %{dep:parser.mly}
       --list-errors
    )
  )
)

;; The completeness check verifies that all error messages are listed in the
;; ".messages" file. It compares the ".messages" file with that generated by
;; Menhir using the above rule.

(rule
  (with-stdout-to parserMessages.check
  (run menhir
    ;; Menhir flags
    %{dep:parser.mly}
    --compare-errors %{dep:parserMessages.auto.messages}
    --compare-errors %{dep:parserMessages.messages}
  ))
)

(rule
  (mode promote)
  (alias runtest)
  (deps (source_tree examples) (source_tree gen_tests.ml))
  (action (with-stdout-to dune.tests (run ./gen_tests.exe)))
)

(include dune.tests)
